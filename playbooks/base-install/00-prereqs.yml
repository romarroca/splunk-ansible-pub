---
- name: Stage 00 - OS prerequisites and baseline hardening
  hosts: splunk_instance
  become: true

  vars_files:
    - ../../group_vars/all.yml
    - ../../group_vars/vault.yml

  vars:
    prereq_packages:
      - ufw
      - cron
      - curl
      - wget
      - openssl
      - ca-certificates
      - gnupg
      - iputils-ping
      - iproute2
      - net-tools
      - dnsutils
      - tcpdump
      - traceroute
      - nmap
      - vim
      - unattended-upgrades
      - fail2ban
      - auditd
      - rsyslog

  handlers:
    - name: Reload ssh
      ansible.builtin.service:
        name: ssh
        state: reloaded
    - name: Restart systemd-resolved
      ansible.builtin.service:
        name: systemd-resolved
        state: restarted
        enabled: true
    - name: Restart systemd-timesyncd
      ansible.builtin.service:
        name: systemd-timesyncd
        state: restarted
        enabled: true

  tasks:
    - name: Ensure systemd-resolved drop-in directory exists
      ansible.builtin.file:
        path: /etc/systemd/resolved.conf.d
        state: directory
        owner: root
        group: root
        mode: "0755"
      when: dns_servers | length > 0

    - name: Configure DNS servers for systemd-resolved
      ansible.builtin.copy:
        dest: /etc/systemd/resolved.conf.d/99-ansible-dns.conf
        owner: root
        group: root
        mode: "0644"
        content: |
          [Resolve]
          DNS={{ dns_servers | join(' ') }}
      when: dns_servers | length > 0
      notify: Restart systemd-resolved

    - name: Ensure systemd-timesyncd drop-in directory exists
      ansible.builtin.file:
        path: /etc/systemd/timesyncd.conf.d
        state: directory
        owner: root
        group: root
        mode: "0755"
      when: ntp_servers | length > 0

    - name: Configure NTP servers for systemd-timesyncd
      ansible.builtin.copy:
        dest: /etc/systemd/timesyncd.conf.d/99-ansible-ntp.conf
        owner: root
        group: root
        mode: "0644"
        content: |
          [Time]
          NTP={{ ntp_servers | join(' ') }}
      when: ntp_servers | length > 0
      notify: Restart systemd-timesyncd

    - name: Apply DNS/NTP configuration handlers before validation
      ansible.builtin.meta: flush_handlers

    - name: Read active DNS nameservers
      ansible.builtin.shell: |
        if command -v resolvectl >/dev/null 2>&1; then
          resolvectl dns | awk '{for(i=2;i<=NF;i++) print $i}' | sort -u
        else
          awk '/^nameserver/{print $2}' /etc/resolv.conf
        fi
      args:
        executable: /bin/bash
      register: dns_nameservers_raw
      changed_when: false

    - name: Build active DNS nameserver fact
      ansible.builtin.set_fact:
        dns_nameservers: "{{ dns_nameservers_raw.stdout_lines | map('trim') | reject('equalto', '') | list }}"

    - name: Ensure at least one DNS nameserver is configured
      ansible.builtin.assert:
        that:
          - dns_nameservers | length > 0
        fail_msg: "No active DNS nameserver found"

    - name: Ensure configured DNS nameservers are present
      ansible.builtin.assert:
        that:
          - (dns_servers | difference(dns_nameservers)) | length == 0
        fail_msg: >-
          Missing expected DNS servers. expected={{ dns_servers }},
          found={{ dns_nameservers }}
      when: dns_servers | length > 0

    - name: Check NTP synchronization state
      ansible.builtin.command: timedatectl show -p NTPSynchronized --value
      register: ntp_sync_state
      changed_when: false

    - name: Check active NTP server name
      ansible.builtin.command: timedatectl show-timesync --property=ServerName --value
      register: ntp_server_name
      changed_when: false
      failed_when: false

    - name: Ensure host is NTP synchronized
      ansible.builtin.assert:
        that:
          - ntp_sync_state.stdout | trim == "yes"
        fail_msg: "Host is not NTP synchronized (timedatectl NTPSynchronized != yes)"
      when: require_ntp_sync | bool

    - name: Ensure active NTP server is in expected list (optional)
      ansible.builtin.assert:
        that:
          - ntp_server_name.stdout | trim in ntp_servers
        fail_msg: >-
          Active NTP server '{{ ntp_server_name.stdout | trim }}' not in expected list {{ ntp_servers }}
      when: ntp_servers | length > 0

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Upgrade installed packages
      ansible.builtin.apt:
        upgrade: dist

    - name: Install prerequisite packages
      ansible.builtin.apt:
        name: "{{ prereq_packages }}"
        state: present

    - name: Enable unattended upgrades
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        owner: root
        group: root
        mode: "0644"
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";

    - name: Disable root SSH login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin\s+'
        line: 'PermitRootLogin no'
        create: false
      notify: Reload ssh

    - name: Allow SSH password auth for approved users
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication\s+'
        line: 'PasswordAuthentication yes'
        create: false
      notify: Reload ssh

    - name: Keep SSH public key auth enabled
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PubkeyAuthentication\s+'
        line: 'PubkeyAuthentication yes'
        create: false
      notify: Reload ssh

    - name: Ensure security services are enabled and running
      ansible.builtin.service:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - cron
        - ufw
        - fail2ban
        - auditd
        - rsyslog

    - name: Set UFW default deny incoming
      community.general.ufw:
        direction: incoming
        policy: deny

    - name: Set UFW default allow outgoing
      community.general.ufw:
        direction: outgoing
        policy: allow

    - name: Allow SSH from any (multi-VLAN admins)
      community.general.ufw:
        rule: allow
        port: "22"
        proto: tcp

    - name: Enable UFW
      community.general.ufw:
        state: enabled
